<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLUXAR | ETHEREAL PRO</title>
    
    <!-- 防闪烁脚本 (必须放在 CSS 之前) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('fluxar_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Manrope:wght@200;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <!-- Markdown & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- 变量定义 (Dark Mode Default) --- */
        :root {
            --bg-deep: #030303;
            --bg-panel: rgba(5, 5, 5, 0.9);
            --bg-input: #141414;
            --bg-bubble-user: #1a1a1a;
            --border: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(0, 243, 255, 0.4);
            
            --text-main: #ffffff;
            --text-dim: #888888;
            --text-code: #eee;
            
            --accent: #00f3ff;
            --accent-dim: rgba(0, 243, 255, 0.1);
            --danger: #ff3344;
            
            --code-bg: #0e0e0e;
            --scroll-thumb: #333;

            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* --- Light Mode Overrides --- */
        [data-theme="light"] {
            --bg-deep: #f0f2f5;
            --bg-panel: rgba(255, 255, 255, 0.85); /* Glassmorphism needs transparency */
            --bg-input: #ffffff;
            --bg-bubble-user: #ffffff;
            --border: rgba(0, 0, 0, 0.08);
            --border-focus: rgba(0, 119, 255, 0.4);
            
            --text-main: #1a1a1a;
            --text-dim: #666666;
            --text-code: #24292e;
            
            --accent: #0066ff; /* 深蓝代替亮青，保证白底对比度 */
            --accent-dim: rgba(0, 102, 255, 0.1);
            
            --code-bg: #ffffff;
            --scroll-thumb: #ccc;
            
            /* 覆盖 Highlight.js 样式为亮色 */
            filter: none; 
        }

        /* 简单的 CSS 动画过渡 */
        body, .sidebar, .input-dock, .dock-glass, .message-bubble, .cyber-input {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; background: var(--bg-deep); color: var(--text-main);
            font-family: var(--font-sans); height: 100vh; overflow: hidden; display: flex;
        }

        /* --- 3D Layer --- */
        #webgl-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

        /* --- Layout --- */
        .app-container { position: relative; z-index: 10; display: flex; width: 100%; height: 100%; }

        /* --- Sidebar --- */
        .sidebar {
            width: 360px; background: var(--bg-panel); backdrop-filter: blur(24px);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            padding: 24px; transform: translateX(0); transition: 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto; z-index: 20;
        }
        .sidebar.closed { transform: translateX(-360px); margin-right: -360px; }

        .header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;
        }
        .brand {
            font-family: 'Manrope', sans-serif; font-weight: 800; font-size: 18px;
            letter-spacing: 1px; display: flex; align-items: center; gap: 8px; color: var(--text-main);
        }
        .brand span { color: var(--accent); }

        .toolbar { display: flex; gap: 8px; }
        .tool-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-dim);
            width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .tool-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Control Widgets */
        .widget { margin-bottom: 28px; }
        .widget-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
            font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600;
        }
        .widget-value { color: var(--accent); font-family: var(--font-mono); }

        /* Inputs */
        .cyber-input, .cyber-select {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-main); padding: 10px 12px; border-radius: 6px; font-family: var(--font-mono); font-size: 12px;
            transition: 0.2s;
        }
        .cyber-input:focus, .cyber-select:focus { border-color: var(--border-focus); box-shadow: 0 0 15px var(--accent-dim); }
        textarea.cyber-input { resize: vertical; min-height: 80px; line-height: 1.5; }

        /* Sliders */
        .range-track { -webkit-appearance: none; width: 100%; height: 4px; background: var(--border); border-radius: 2px; }
        .range-track::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; background: var(--text-main); border-radius: 50%;
            cursor: pointer; transition: 0.2s; border: 2px solid var(--bg-deep);
        }
        .range-track::-webkit-slider-thumb:hover { background: var(--accent); transform: scale(1.2); }

        /* Toggle Switch */
        .toggle { position: relative; width: 32px; height: 18px; cursor: pointer; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider-knob { position: absolute; inset: 0; background: var(--border); border-radius: 20px; transition: 0.3s; }
        .slider-knob:before {
            content: ""; position: absolute; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        input:checked + .slider-knob { background: var(--accent); }
        input:checked + .slider-knob:before { transform: translateX(14px); background: var(--bg-deep); }

        /* Injection Stack */
        .injection-stack {
            border: 1px solid var(--border); border-radius: 8px; padding: 4px;
            background: rgba(128,128,128,0.05); transition: 0.3s; display: flex; flex-direction: column; gap: 4px;
        }
        .injection-stack.active { border-color: var(--accent); background: var(--accent-dim); }
        .stack-header { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
        .injection-list { display: flex; flex-direction: column; gap: 8px; padding: 8px; }
        
        .injection-item {
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
            padding: 10px; position: relative; animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .item-meta { display: grid; grid-template-columns: 1fr 60px 24px; gap: 8px; margin-bottom: 8px; }
        .depth-input { 
            background: var(--bg-deep); border: 1px solid var(--border); color: var(--accent); 
            text-align: center; border-radius: 4px; font-size: 11px; font-family: var(--font-mono);
        }
        .del-btn { background: transparent; border: none; color: var(--text-dim); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .del-btn:hover { color: var(--danger); }
        .add-btn {
            width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--border);
            color: var(--text-dim); font-size: 11px; cursor: pointer; border-radius: 6px; margin-top: 4px; transition: 0.2s;
        }
        .add-btn:hover { border-color: var(--text-main); color: var(--text-main); }

        /* Main Chat */
        .main-stage { flex: 1; position: relative; display: flex; flex-direction: column; }
        .stage-header { height: 60px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; z-index: 30; }
        
        #chat-scroll {
            flex: 1; overflow-y: auto; padding: 20px 20% 140px 20%;
            display: flex; flex-direction: column; gap: 32px; scroll-behavior: smooth;
        }
        
        .msg-row { display: flex; flex-direction: column; gap: 8px; opacity: 0; transform: translateY(10px); animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        .msg-meta { font-size: 10px; font-weight: 700; letter-spacing: 1px; color: var(--text-dim); text-transform: uppercase; }
        .msg-meta.ai { color: var(--accent); }
        
        .msg-content { font-size: 15px; line-height: 1.6; color: var(--text-main); }
        .msg-content p { margin: 0 0 1em 0; }
        .msg-content pre { background: var(--code-bg); border: 1px solid var(--border); padding: 16px; border-radius: 8px; overflow-x: auto; color: var(--text-code); }
        .msg-content code { font-family: var(--font-mono); background: rgba(128,128,128,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; color: var(--accent); }
        
        /* User Bubble style for distinction */
        .msg-row.user-row .msg-content {
            background: var(--bg-bubble-user); border: 1px solid var(--border);
            padding: 12px 16px; border-radius: 12px 12px 2px 12px; align-self: flex-start; display: inline-block;
        }

        .input-dock {
            position: absolute; bottom: 0; left: 0; width: 100%; pointer-events: none;
            padding: 0 20% 40px 20%; z-index: 40;
        }
        .dock-glass {
            pointer-events: auto; background: var(--bg-panel); backdrop-filter: blur(16px);
            border: 1px solid var(--border); border-radius: 16px; padding: 8px;
            display: flex; align-items: flex-end; gap: 8px; box-shadow: 0 24px 48px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .dock-glass:focus-within { border-color: var(--border-focus); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        #user-text {
            flex: 1; background: transparent; border: none; color: var(--text-main); padding: 14px;
            font-family: var(--font-sans); font-size: 15px; resize: none; height: 50px;
        }
        #send-btn {
            width: 42px; height: 42px; background: var(--text-main); color: var(--bg-deep); border: none;
            border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; font-size: 18px;
        }
        #send-btn:hover { transform: scale(1.05); background: var(--accent); color: white; }
        #send-btn:disabled { background: var(--border); color: var(--text-dim); transform: none; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 3px; }

        @media (max-width: 1200px) {
            .sidebar { position: absolute; left: -360px; height: 100%; }
            .sidebar.open { transform: translateX(360px); }
            #chat-scroll, .input-dock { padding-left: 5%; padding-right: 5%; }
        }
    </style>
</head>
<body>

    <div id="webgl-canvas"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar custom-scrollbar" id="sidebar">
            <div class="header-row">
                <div class="brand"><i class="ri-vip-diamond-line"></i> FLUXAR <span>PRO</span></div>
                
                <!-- Tools: Theme & Language -->
                <div class="toolbar">
                    <button class="tool-btn" id="theme-btn" title="Toggle Theme">
                        <i class="ri-sun-line"></i>
                    </button>
                    <button class="tool-btn" id="lang-btn" title="Switch Language" style="font-size: 10px; font-weight: 700;">
                        EN
                    </button>
                </div>
            </div>

            <!-- 1. Model -->
            <div class="widget">
                <div class="widget-header" data-i18n="base_model">Base Model</div>
                <select id="model-select" class="cyber-select">
                    {% for model in model_names %}
                    <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 2. System Persona -->
            <div class="widget">
                <div class="widget-header" data-i18n="core_persona">Core Persona</div>
                <textarea id="system-prompt" class="cyber-input" placeholder="Define absolute system behavior..."></textarea>
            </div>

            <!-- 3. Temperature -->
            <div class="widget">
                <div class="widget-header"><span data-i18n="entropy">Entropy</span> <span id="temp-val" class="widget-value">0.7</span></div>
                <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.7" class="range-track">
            </div>

            <!-- 4. Context Limit -->
            <div class="widget">
                <div class="widget-header"><span data-i18n="ctx_limit">Context Limit</span> <span id="ctx-val" class="widget-value">∞</span></div>
                <input type="range" id="ctx-slider" min="0" max="6" step="1" value="6" class="range-track">
            </div>

            <!-- 5. Stream -->
            <div class="widget">
                <div class="widget-header">
                    <span data-i18n="stream">Realtime Stream</span>
                    <label class="toggle">
                        <input type="checkbox" id="stream-check" checked>
                        <span class="slider-knob"></span>
                    </label>
                </div>
            </div>

            <!-- 6. Injection Stack -->
            <div class="widget">
                <div class="injection-stack" id="injection-stack">
                    <div class="stack-header">
                        <div class="widget-header" style="margin:0" data-i18n="mem_inject">Memory Injection</div>
                        <label class="toggle">
                            <input type="checkbox" id="inject-active">
                            <span class="slider-knob"></span>
                        </label>
                    </div>
                    <div id="injection-list" class="injection-list"></div>
                    <button id="add-inject-btn" class="add-btn"><i class="ri-add-line"></i> <span data-i18n="add_block">Add Message Block</span></button>
                </div>
                <div style="margin-top:8px; font-size:9px; color:var(--text-dim); line-height:1.4;" data-i18n="inject_hint">
                    *Active injections are re-applied before every message.
                </div>
            </div>

            <div style="margin-top: auto;">
                <button id="clear-btn" class="cyber-input" style="border-color: var(--border); cursor: pointer; color: var(--danger);">
                    <i class="ri-eraser-line"></i> <span data-i18n="wipe">Wipe Memory</span>
                </button>
            </div>
        </aside>

        <!-- Main Stage -->
        <main class="main-stage">
            <div class="stage-header">
                <button id="menu-btn" style="background:none; border:none; color:var(--text-main); font-size:20px; cursor:pointer;"><i class="ri-menu-line"></i></button>
            </div>

            <div id="chat-scroll">
                <div class="msg-row">
                    <div class="msg-meta ai">Fluxar System</div>
                    <div class="msg-content" data-i18n="welcome">Neural link established. Waiting for input...</div>
                </div>
            </div>

            <div class="input-dock">
                <div class="dock-glass">
                    <textarea id="user-text" placeholder="Transmission..." rows="1"></textarea>
                    <button id="send-btn"><i class="ri-arrow-up-line"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script type="module">
        /* -------------------------------------------------------------------------- */
        /*                        VISUAL CORE & THEME LOGIC                           */
        /* -------------------------------------------------------------------------- */
        
        // i18n Dictionary
        const i18n = {
            zh: {
                base_model: "基础模型", core_persona: "System", entropy: "温度 (Entropy)",
                ctx_limit: "上下文长度", stream: "流式响应", mem_inject: "记忆注入",
                add_block: "添加消息块", inject_hint: "*激活的注入内容将在每次对话前自动载入",
                wipe: "清空会话", welcome: "等待输入指令...",
                role_sys: "System", role_user: "User", role_ai: "Assistant"
            },
            en: {
                base_model: "Base Model", core_persona: "Core Persona", entropy: "Entropy",
                ctx_limit: "Context Limit", stream: "Realtime Stream", mem_inject: "Memory Injection",
                add_block: "Add Message Block", inject_hint: "*Active injections are re-applied before every message.",
                wipe: "Wipe Memory", welcome: "Waiting for input...",
                role_sys: "System", role_user: "User", role_ai: "Assistant"
            }
        };

        let currentLang = localStorage.getItem('fluxar_lang') || 'en';
        const savedTheme = localStorage.getItem('fluxar_theme') || 'dark';

        // Apply text updates
        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });
            document.getElementById('lang-btn').innerText = currentLang.toUpperCase();
            document.getElementById('user-text').placeholder = currentLang === 'en' ? "Transmission..." : "输入消息...";
            
            // 更新注入列表里的 Role 选项文本
            document.querySelectorAll('.role-sel').forEach(sel => {
                sel.options[0].text = i18n[currentLang].role_sys;
                sel.options[1].text = i18n[currentLang].role_user;
                sel.options[2].text = i18n[currentLang].role_ai;
            });
        }
        
        document.getElementById('lang-btn').onclick = () => {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            localStorage.setItem('fluxar_lang', currentLang);
            updateLanguage();
        };
        // Init Lang
        updateLanguage();

        // Theme & 3D Logic
        const themeBtn = document.getElementById('theme-btn');
        let isLight = savedTheme === 'light';
        
        // 3D Setup
        const canvas = document.getElementById('webgl-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
        camera.position.z = 5;
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(innerWidth, innerHeight);
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        canvas.appendChild(renderer.domElement);

        // Shaders (Updated for theme support)
        // We pass 'isLight' via uniform 'theme' (0=Dark, 1=Light) to invert colors if needed, 
        // but JS color passing is easier.
        const vShader = `uniform float time;uniform float act;varying float vDisp;vec3 mod289(vec3 x){return x-floor(x*(1./289.))*289.;}vec4 mod289(vec4 x){return x-floor(x*(1./289.))*289.;}vec4 permute(vec4 x){return mod289(((x*34.)+1.)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1./6.,1./3.);const vec4 D=vec4(0.,.5,1.,2.);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.,i1.z,i2.z,1.))+i.y+vec4(0.,i1.y,i2.y,1.))+i.x+vec4(0.,i1.x,i2.x,1.));float n_=.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.+1.;vec4 s1=floor(b1)*2.+1.;vec4 sh=-step(h,vec4(0.));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.);m=m*m;return 42.*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}void main(){vDisp=snoise(position*2.+time*(1.+act*2.));vec3 np=position+normal*(vDisp*(.2+act*.5));gl_Position=projectionMatrix*modelViewMatrix*vec4(np,1.);gl_PointSize=4.;}`;
        const fShader = `uniform float op;uniform vec3 cA;uniform vec3 cB;varying float vDisp;void main(){vec3 c=mix(cA,cB,vDisp*2.+.5);if(op<.01)discard;gl_FragColor=vec4(c,op);}`;

        const unis = { 
            time: {value:0}, act: {value:0}, op: {value:0}, 
            cA: {value:new THREE.Color()}, cB: {value:new THREE.Color()} 
        };
        const sphereMat = new THREE.ShaderMaterial({
            uniforms: unis, vertexShader: vShader, fragmentShader: fShader, 
            wireframe: true, transparent: true, depthWrite: false,
            blending: THREE.AdditiveBlending // Will change based on theme
        });
        const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(2,40), sphereMat);
        sphere.position.set(4,0,0); sphere.scale.set(0.1,0.1,0.1); scene.add(sphere);

        const starsMat = new THREE.PointsMaterial({size:.02, color:0x444444, transparent:true, opacity:.4});
        const pGeo = new THREE.BufferGeometry(); 
        const pPos = new Float32Array(3000);
        for(let i=0;i<3000;i++) pPos[i]=(Math.random()-.5)*40;
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos,3));
        const stars = new THREE.Points(pGeo, starsMat);
        scene.add(stars);

        function updateThemeVisuals() {
            const root = document.documentElement;
            if(isLight) {
                root.setAttribute('data-theme', 'light');
                themeBtn.innerHTML = '<i class="ri-moon-line"></i>';
                
                // 3D Light Mode
                // Dark background particles for contrast against light bg
                starsMat.color.setHex(0xaaaaaa); 
                // Sphere colors: Deep Blue to Magenta (Darker for visibility on white)
                unis.cA.value.setHex(0x0044aa); 
                unis.cB.value.setHex(0xaa00aa);
                // Switch Blending to Normal (Additive disappears on white)
                sphereMat.blending = THREE.NormalBlending;
            } else {
                root.removeAttribute('data-theme');
                themeBtn.innerHTML = '<i class="ri-sun-line"></i>';
                
                // 3D Dark Mode
                starsMat.color.setHex(0x444444);
                // Sphere colors: Cyan to Purple (Glowing)
                unis.cA.value.setHex(0x00f3ff);
                unis.cB.value.setHex(0x7000ff);
                sphereMat.blending = THREE.AdditiveBlending;
            }
        }

        themeBtn.onclick = () => {
            isLight = !isLight;
            localStorage.setItem('fluxar_theme', isLight ? 'light' : 'dark');
            updateThemeVisuals();
        };
        // Init Theme
        updateThemeVisuals();

        // Loop
        const clock = new THREE.Clock();
        function tick() {
            unis.time.value = clock.getElapsedTime();
            sphere.rotation.y+=0.004; stars.rotation.y-=0.0005;
            renderer.render(scene, camera); requestAnimationFrame(tick);
        }
        tick();
        window.onresize=()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)};

        /* -------------------------------------------------------------------------- */
        /*                            APPLICATION LOGIC                               */
        /* -------------------------------------------------------------------------- */
        const sessId = localStorage.getItem('flux_pro_id') || crypto.randomUUID();
        localStorage.setItem('flux_pro_id', sessId);

        // Context Limit
        const ctxSlider = document.getElementById('ctx-slider');
        const ctxLabel = document.getElementById('ctx-val');
        const ctxMap = [4000, 16000, 32000, 128000, 256000, 1000000, null];
        const ctxTxt = ["4K", "16K", "32K", "128K", "256K", "1M", "∞"];
        ctxSlider.oninput = () => ctxLabel.innerText = ctxTxt[ctxSlider.value];

        // Injection Logic
        const injectList = document.getElementById('injection-list');
        const addInjectBtn = document.getElementById('add-inject-btn');
        const injectActive = document.getElementById('inject-active');
        const injectStack = document.getElementById('injection-stack');

        injectActive.onchange = () => injectStack.classList.toggle('active', injectActive.checked);

        function createInjectionItem(role='system', content='', depth=0) {
            const div = document.createElement('div');
            div.className = 'injection-item';
            div.innerHTML = `
                <div class="item-meta">
                    <select class="cyber-select role-sel" style="padding:4px;">
                        <option value="system" ${role==='system'?'selected':''}>${i18n[currentLang].role_sys}</option>
                        <option value="user" ${role==='user'?'selected':''}>${i18n[currentLang].role_user}</option>
                        <option value="assistant" ${role==='assistant'?'selected':''}>${i18n[currentLang].role_ai}</option>
                    </select>
                    <input type="number" class="depth-input" value="${depth}" placeholder="Dp" title="Depth">
                    <button class="del-btn"><i class="ri-close-line"></i></button>
                </div>
                <textarea class="cyber-input content-txt" rows="2" placeholder="Context...">${content}</textarea>
            `;
            div.querySelector('.del-btn').onclick = () => div.remove();
            return div;
        }

        addInjectBtn.onclick = () => injectList.appendChild(createInjectionItem());
        if(injectList.children.length === 0) injectList.appendChild(createInjectionItem());

        // Chat UI
        const chatScroll = document.getElementById('chat-scroll');
        const userText = document.getElementById('user-text');
        const sendBtn = document.getElementById('send-btn');
        userText.oninput = function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,150)+'px';};

        function addMsg(role, text) {
            const div = document.createElement('div'); 
            div.className = `msg-row ${role === 'user' ? 'user-row' : ''}`;
            const displayName = role==='user' 
                ? i18n[currentLang].role_user 
                : (role==='assistant' ? 'Fluxar' : 'System');
            
            div.innerHTML = `
                <div class="msg-meta ${role==='assistant'?'ai':''}">${displayName}</div>
                <div class="msg-content">${role==='user'?text:marked.parse(text)}</div>
            `;
            chatScroll.appendChild(div);
            if(role!=='user') div.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
            chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' });
            return div.querySelector('.msg-content');
        }

        // Send Handler
        const modelSel = document.getElementById('model-select');
        const sysPrompt = document.getElementById('system-prompt');
        const tempSlide = document.getElementById('temp-slider');
        const streamCheck = document.getElementById('stream-check');

        async function send() {
            const txt = userText.value.trim();
            if(!txt) return;
            userText.value=''; userText.style.height='50px';
            userText.disabled=true; sendBtn.disabled=true;
            addMsg('user', txt);

            // 3D Trigger
            gsap.to(unis.op, {value:1, duration:1});
            gsap.to(sphere.scale, {x:1, y:1, z:1, duration:1.5, ease:"back.out(1.7)"});
            gsap.to(unis.act, {value:1, duration:0.5});

            try {
                if(injectActive.checked) {
                    const items = injectList.querySelectorAll('.injection-item');
                    const injections = [];
                    items.forEach(item => {
                        const r = item.querySelector('.role-sel').value;
                        const c = item.querySelector('.content-txt').value.trim();
                        const d = parseInt(item.querySelector('.depth-input').value) || 0;
                        if(c) injections.push({role:r, content:c, depth:d});
                    });
                    if(injections.length > 0) {
                        await fetch('/insert-message/', {
                            method: 'POST', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({session_id:sessId, model:modelSel.value, insertions:injections, lifetime:'once'})
                        });
                    }
                }

                const res = await fetch('/chat/', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        session_id: sessId, model: modelSel.value, message: txt, use_history: true,
                        stream: streamCheck.checked, system_prompt: sysPrompt.value || null,
                        temperature: parseFloat(tempSlide.value), top_p: 1.0, max_tokens: ctxMap[ctxSlider.value]
                    })
                });

                if(streamCheck.checked) {
                    const reader = res.body.getReader();
                    const dec = new TextDecoder();
                    let full = "";
                    const bubble = addMsg('assistant', '...');
                    while(true) {
                        const {done, value} = await reader.read();
                        if(done) break;
                        const lines = dec.decode(value, {stream:true}).split('\n');
                        for(const l of lines) {
                            if(l.startsWith('data: ')) {
                                const j = l.slice(6);
                                if(j==='[DONE]') break;
                                try {
                                    const d = JSON.parse(j);
                                    if(d.content) {
                                        full += d.content;
                                        bubble.innerHTML = marked.parse(full);
                                        chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' });
                                    }
                                }catch(e){}
                            }
                        }
                    }
                    bubble.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
                } else {
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    addMsg('assistant', data.reply);
                }
            } catch(e) { addMsg('assistant', `Error: ${e.message}`); } 
            finally {
                userText.disabled=false; sendBtn.disabled=false; userText.focus();
                gsap.to(unis.act, {value:0, duration:1});
                gsap.to(sphere.scale, {x:0.01, y:0.01, z:0.01, duration:1, ease:"power2.in"});
                gsap.to(unis.op, {value:0, duration:0.8, delay:0.2});
            }
        }

        sendBtn.onclick=send;
        userText.onkeydown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}};
        
        document.getElementById('menu-btn').onclick=()=>{
            const sb=document.getElementById('sidebar');
            sb.classList.toggle('closed');
        };
        if(innerWidth>1200) document.getElementById('sidebar').classList.remove('closed');
        
        document.getElementById('temp-slider').oninput=(e)=>document.getElementById('temp-val').innerText=e.target.value;
        document.getElementById('clear-btn').onclick=async()=>{
            if(confirm('Confirm wipe?')) {
                await fetch(`/clear-history/?model=${modelSel.value}&session_id=${sessId}`, {method:'POST'});
                chatScroll.innerHTML='';
            }
        };
    </script>
</body>
</html>